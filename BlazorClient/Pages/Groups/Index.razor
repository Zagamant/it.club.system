@page "/groups"
@using Microsoft.AspNetCore.Authorization
@using BlazorClient.Services.GroupManagement
@using System.BLL.Models.GroupManagement
@attribute [Authorize]
@inject IGroupService GroupService
    <div class="head">
        <h1>Groups</h1>
        <NavLink href="groups/add" class="btn btn-sm btn-success mb-2">Add Group</NavLink>
    </div>
        <table class="table">
            <DataGrid TItem="GroupModel"
                      Data="@groups"
                      TotalItems="@totalCount"
                      Filterable="true"
                      FilterMethod="DataGridFilterMethod.Contains">
                <DataGridColumns>
                    <DataGridCommandColumn TItem="GroupModel">
                        <DeleteCommandTemplate>
                            <Button Color="Color.Danger" Clicked="@context.Clicked">Delete</Button>
                        </DeleteCommandTemplate>
                    </DataGridCommandColumn>
                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.Title)" Caption="Title" />

                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.LessonsPerWeek)" Caption="LessonsPerWeek" />
                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.OnlineConversationLink)" Caption="OnlineConversationLink" />
                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.StartDate)" Caption="StartDate" />
                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.EndDate)" Caption="EndDate" />
                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.Capacity)" Caption="Capacity" />
                    <DataGridColumn TItem="GroupModel" Field="@nameof(GroupModel.Status)" Caption="Status" />

                    <DataGridColumn TItem="GroupModel" Field="@nameof( GroupModel.Id)" Sortable="false" Filterable="false">
                        <DisplayTemplate>
                            <Button Color="Color.Danger" Clicked="@(() => DeleteUser(context.Id))">
                                Delete
                            </Button>
                        </DisplayTemplate>
                    </DataGridColumn>
                </DataGridColumns>
            </DataGrid>
        </table>
    @code {
        private bool loading;
        private IList<GroupModel> groups;
        private bool IsDeleting;
        private int totalCount;

        protected override async Task OnInitializedAsync()
        {
            loading = true;
            groups = (await GroupService.GetAllAsync()).ToList();
            totalCount = groups.Count;
            loading = false;
        }

        private async void DeleteUser(int id)
        {
            var user = groups.First(x => x.Id == id);
            IsDeleting = true;
            await GroupService.DeleteAsync(id);
            groups.Remove(user);
            StateHasChanged();
            IsDeleting = false;
        }

    }